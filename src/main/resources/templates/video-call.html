<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Call</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div id="video_grid"></div>
<script>
  let localStream;
  let peerConnection;
  const roomId = "YOUR_ROOM_ID";  // Replace with dynamic roomId if needed
  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  // Initialize WebSocket connection with STOMP
  const stompClient = Stomp.over(new SockJS('/video-call'));

  stompClient.connect({}, () => {
      stompClient.subscribe(`/topic/join/${roomId}`, (message) => {
          console.log("A user joined the room:", message.body);
          // Logic for handling new joiners
      });

      stompClient.subscribe(`/topic/offer/${roomId}`, async (message) => {
          const { sdp } = JSON.parse(message.body);
          console.log("Received offer:", sdp);

          await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }));
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);

          const answerMessage = {
              type: "answer",
              sdp: answer.sdp
          };
          stompClient.send(`/app/answer/${roomId}`, {}, JSON.stringify(answerMessage));
      });

      stompClient.subscribe(`/topic/answer/${roomId}`, async (message) => {
          const { sdp } = JSON.parse(message.body);
          console.log("Received answer:", sdp);

          await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp }));
      });

      stompClient.subscribe(`/topic/ice/${roomId}`, (message) => {
          const { candidate } = JSON.parse(message.body);
          console.log("Received ICE candidate:", candidate);

          if (candidate) {
              peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          }
      });
  });

  // Function to send an ICE candidate message over WebSocket
  function sendIceCandidate(candidate) {
      const iceMessage = {
          type: "ice",
          candidate: candidate
      };
      stompClient.send(`/app/ice/${roomId}`, {}, JSON.stringify(iceMessage));
  }

  // Set up WebRTC peer connection
  async function startCall() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("video_grid").srcObject = localStream;

      peerConnection = new RTCPeerConnection(servers);
      peerConnection.addStream(localStream);

      peerConnection.ontrack = (event) => {
          const remoteVideo = document.createElement("video");
          remoteVideo.srcObject = event.streams[0];
          remoteVideo.autoplay = true;
          document.getElementById("video_grid").appendChild(remoteVideo);
      };

      peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
              sendIceCandidate(event.candidate);
          }
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      const offerMessage = {
          type: "offer",
          sdp: offer.sdp
      };
      stompClient.send(`/app/offer/${roomId}`, {}, JSON.stringify(offerMessage));
  }

  startCall();  // Start the call on page load or trigger it as needed
</script>
</body>
</html>
